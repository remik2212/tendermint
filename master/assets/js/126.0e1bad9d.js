(window.webpackJsonp=window.webpackJsonp||[]).push([[126],{676:function(e,t,n){"use strict";n.r(t);var a=n(1),i=Object(a.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"adr-065-custom-event-indexing"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#adr-065-custom-event-indexing"}},[e._v("#")]),e._v(" ADR 065: Custom Event Indexing")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#adr-065-custom-event-indexing"}},[e._v("ADR 065: Custom Event Indexing")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#changelog"}},[e._v("Changelog")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#status"}},[e._v("Status")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#context"}},[e._v("Context")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#alternative-approaches"}},[e._v("Alternative Approaches")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#decision"}},[e._v("Decision")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#detailed-design"}},[e._v("Detailed Design")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#eventsink"}},[e._v("EventSink")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#supported-sinks"}},[e._v("Supported Sinks")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#kveventsink"}},[n("code",[e._v("KVEventSink")])])]),e._v(" "),n("li",[n("a",{attrs:{href:"#psqleventsink"}},[n("code",[e._v("PSQLEventSink")])])])])]),e._v(" "),n("li",[n("a",{attrs:{href:"#configuration"}},[e._v("Configuration")])])])]),e._v(" "),n("li",[n("a",{attrs:{href:"#future-improvements"}},[e._v("Future Improvements")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#consequences"}},[e._v("Consequences")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#positive"}},[e._v("Positive")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#negative"}},[e._v("Negative")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#neutral"}},[e._v("Neutral")])])])]),e._v(" "),n("li",[n("a",{attrs:{href:"#references"}},[e._v("References")])])])])]),e._v(" "),n("h2",{attrs:{id:"changelog"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#changelog"}},[e._v("#")]),e._v(" Changelog")]),e._v(" "),n("ul",[n("li",[e._v("April 1, 2021: Initial Draft (@alexanderbez)")]),e._v(" "),n("li",[e._v("April 28, 2021: Specify search capabilities are only supported through the KV indexer (@marbar3778)")]),e._v(" "),n("li",[e._v("May 19, 2021: Update the SQL schema and the eventsink interface (@jayt106)")])]),e._v(" "),n("h2",{attrs:{id:"status"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#status"}},[e._v("#")]),e._v(" Status")]),e._v(" "),n("p",[e._v("Accepted")]),e._v(" "),n("h2",{attrs:{id:"context"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#context"}},[e._v("#")]),e._v(" Context")]),e._v(" "),n("p",[e._v("Currently, Tendermint Core supports block and transaction event indexing through\nthe "),n("code",[e._v("tx_index.indexer")]),e._v(" configuration. Events are captured in transactions and\nare indexed via a "),n("code",[e._v("TxIndexer")]),e._v(" type. Events are captured in blocks, specifically\nfrom "),n("code",[e._v("BeginBlock")]),e._v(" and "),n("code",[e._v("EndBlock")]),e._v(" application responses, and are indexed via a\n"),n("code",[e._v("BlockIndexer")]),e._v(" type. Both of these types are managed by a single "),n("code",[e._v("IndexerService")]),e._v("\nwhich is responsible for consuming events and sending those events off to be\nindexed by the respective type.")]),e._v(" "),n("p",[e._v("In addition to indexing, Tendermint Core also supports the ability to query for\nboth indexed transaction and block events via Tendermint's RPC layer. The ability\nto query for these indexed events facilitates a great multitude of upstream client\nand application capabilities, e.g. block explorers, IBC relayers, and auxiliary\ndata availability and indexing services.")]),e._v(" "),n("p",[e._v("Currently, Tendermint only supports indexing via a "),n("code",[e._v("kv")]),e._v(" indexer, which is supported\nby an underlying embedded key/value store database. The "),n("code",[e._v("kv")]),e._v(" indexer implements\nits own indexing and query mechanisms. While the former is somewhat trivial,\nproviding a rich and flexible query layer is not as trivial and has caused many\nissues and UX concerns for upstream clients and applications.")]),e._v(" "),n("p",[e._v("The fragile nature of the proprietary "),n("code",[e._v("kv")]),e._v(" query engine and the potential\nperformance and scaling issues that arise when a large number of consumers are\nintroduced, motivate the need for a more robust and flexible indexing and query\nsolution.")]),e._v(" "),n("h2",{attrs:{id:"alternative-approaches"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#alternative-approaches"}},[e._v("#")]),e._v(" Alternative Approaches")]),e._v(" "),n("p",[e._v("With regards to alternative approaches to a more robust solution, the only serious\ncontender that was considered was to transition to using "),n("a",{attrs:{href:"https://www.sqlite.org/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("SQLite"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("p",[e._v("While the approach would work, it locks us into a specific query language and\nstorage layer, so in some ways it's only a bit better than our current approach.\nIn addition, the implementation would require the introduction of CGO into the\nTendermint Core stack, whereas right now CGO is only introduced depending on\nthe database used.")]),e._v(" "),n("h2",{attrs:{id:"decision"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#decision"}},[e._v("#")]),e._v(" Decision")]),e._v(" "),n("p",[e._v("We will adopt a similar approach to that of the Cosmos SDK's "),n("code",[e._v("KVStore")]),e._v(" state\nlistening described in "),n("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-038-state-listening.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("ADR-038"),n("OutboundLink")],1),e._v(".")]),e._v(" "),n("p",[e._v("Namely, we will perform the following:")]),e._v(" "),n("ul",[n("li",[e._v("Introduce a new interface, "),n("code",[e._v("EventSink")]),e._v(", that all data sinks must implement.")]),e._v(" "),n("li",[e._v("Augment the existing "),n("code",[e._v("tx_index.indexer")]),e._v(" configuration to now accept a series\nof one or more indexer types, i.e sinks.")]),e._v(" "),n("li",[e._v("Combine the current "),n("code",[e._v("TxIndexer")]),e._v(" and "),n("code",[e._v("BlockIndexer")]),e._v(" into a single "),n("code",[e._v("KVEventSink")]),e._v("\nthat implements the "),n("code",[e._v("EventSink")]),e._v(" interface.")]),e._v(" "),n("li",[e._v("Introduce an additional "),n("code",[e._v("EventSink")]),e._v(" that is backed by "),n("a",{attrs:{href:"https://www.postgresql.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("PostgreSQL"),n("OutboundLink")],1),e._v(".\n"),n("ul",[n("li",[e._v("Implement the necessary schemas to support both block and transaction event\nindexing.")])])]),e._v(" "),n("li",[e._v("Update "),n("code",[e._v("IndexerService")]),e._v(" to use a series of "),n("code",[e._v("EventSinks")]),e._v(".")]),e._v(" "),n("li",[e._v("Proxy queries to the relevant sink's native query layer.")]),e._v(" "),n("li",[e._v("Update all relevant RPC methods.")])]),e._v(" "),n("h2",{attrs:{id:"detailed-design"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#detailed-design"}},[e._v("#")]),e._v(" Detailed Design")]),e._v(" "),n("h3",{attrs:{id:"eventsink"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#eventsink"}},[e._v("#")]),e._v(" EventSink")]),e._v(" "),n("p",[e._v("We introduce the "),n("code",[e._v("EventSink")]),e._v(" interface type that all supported sinks must implement.\nThe interface is defined as follows:")]),e._v(" "),n("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"dHlwZSBFdmVudFNpbmsgaW50ZXJmYWNlIHsKICBJbmRleEJsb2NrRXZlbnRzKHR5cGVzLkV2ZW50RGF0YU5ld0Jsb2NrSGVhZGVyKSBlcnJvcgogIEluZGV4VHhFdmVudHMoW10qYWJjaS5UeFJlc3VsdCkgZXJyb3IKCiAgU2VhcmNoQmxvY2tFdmVudHMoY29udGV4dC5Db250ZXh0LCAqcXVlcnkuUXVlcnkpIChbXWludDY0LCBlcnJvcikKICBTZWFyY2hUeEV2ZW50cyhjb250ZXh0LkNvbnRleHQsICpxdWVyeS5RdWVyeSkgKFtdKmFiY2kuVHhSZXN1bHQsIGVycm9yKQoKICBHZXRUeEJ5SGFzaChbXWJ5dGUpICgqYWJjaS5UeFJlc3VsdCwgZXJyb3IpCiAgSGFzQmxvY2soaW50NjQpIChib29sLCBlcnJvcikKCiAgVHlwZSgpIEV2ZW50U2lua1R5cGUKICBTdG9wKCkgZXJyb3IKfQo="}}),e._v(" "),n("p",[e._v("The "),n("code",[e._v("IndexerService")]),e._v("  will accept a list of one or more "),n("code",[e._v("EventSink")]),e._v(" types. During\nthe "),n("code",[e._v("OnStart")]),e._v(" method it will call the appropriate APIs on each "),n("code",[e._v("EventSink")]),e._v(" to\nindex both block and transaction events.")]),e._v(" "),n("h3",{attrs:{id:"supported-sinks"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#supported-sinks"}},[e._v("#")]),e._v(" Supported Sinks")]),e._v(" "),n("p",[e._v("We will initially support two "),n("code",[e._v("EventSink")]),e._v(" types out of the box.")]),e._v(" "),n("h4",{attrs:{id:"kveventsink"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#kveventsink"}},[e._v("#")]),e._v(" "),n("code",[e._v("KVEventSink")])]),e._v(" "),n("p",[e._v("This type of "),n("code",[e._v("EventSink")]),e._v(" is a combination of the  "),n("code",[e._v("TxIndexer")]),e._v(" and "),n("code",[e._v("BlockIndexer")]),e._v("\nindexers, both of which are backed by a single embedded key/value database.")]),e._v(" "),n("p",[e._v("A bulk of the existing business logic will remain the same, but the existing APIs\nmapped to the new "),n("code",[e._v("EventSink")]),e._v(" API. Both types will be removed in favor of a single\n"),n("code",[e._v("KVEventSink")]),e._v(" type.")]),e._v(" "),n("p",[e._v("The "),n("code",[e._v("KVEventSink")]),e._v(" will be the only "),n("code",[e._v("EventSink")]),e._v(" enabled by default, so from a UX\nperspective, operators should not notice a difference apart from a configuration\nchange.")]),e._v(" "),n("p",[e._v("We omit "),n("code",[e._v("EventSink")]),e._v(" implementation details as it should be fairly straightforward\nto map the existing business logic to the new APIs.")]),e._v(" "),n("h4",{attrs:{id:"psqleventsink"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#psqleventsink"}},[e._v("#")]),e._v(" "),n("code",[e._v("PSQLEventSink")])]),e._v(" "),n("p",[e._v("This type of "),n("code",[e._v("EventSink")]),e._v(" indexes block and transaction events into a "),n("a",{attrs:{href:"https://www.postgresql.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("PostgreSQL"),n("OutboundLink")],1),e._v(".\ndatabase. We define and automatically migrate the following schema when the\n"),n("code",[e._v("IndexerService")]),e._v(" starts.")]),e._v(" "),n("p",[e._v("The postgres eventsink will not support "),n("code",[e._v("tx_search")]),e._v(", "),n("code",[e._v("block_search")]),e._v(", "),n("code",[e._v("GetTxByHash")]),e._v(" and "),n("code",[e._v("HasBlock")]),e._v(".")]),e._v(" "),n("tm-code-block",{staticClass:"codeblock",attrs:{language:"sql",base64:"LS0gVGFibGUgRGVmaW5pdGlvbiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpDUkVBVEUgVFlQRSBibG9ja19ldmVudF90eXBlIEFTIEVOVU0gKCdiZWdpbl9ibG9jaycsICdlbmRfYmxvY2snLCAnJyk7CgpDUkVBVEUgVEFCTEUgYmxvY2tfZXZlbnRzICgKICAgIGlkIFNFUklBTCBQUklNQVJZIEtFWSwKICAgIGtleSBWQVJDSEFSIE5PVCBOVUxMLAogICAgdmFsdWUgVkFSQ0hBUiBOT1QgTlVMTCwKICAgIGhlaWdodCBJTlRFR0VSIE5PVCBOVUxMLAogICAgdHlwZSBibG9ja19ldmVudF90eXBlLAogICAgY3JlYXRlZF9hdCBUSU1FU1RBTVBUWiBOT1QgTlVMTCwKICAgIGNoYWluX2lkIFZBUkNIQVIgTk9UIE5VTEwKKTsKCkNSRUFURSBUQUJMRSB0eF9yZXN1bHRzICgKICAgIGlkIFNFUklBTCBQUklNQVJZIEtFWSwKICAgIHR4X3Jlc3VsdCBCWVRFQSBOT1QgTlVMTCwKICAgIGNyZWF0ZWRfYXQgVElNRVNUQU1QVFogTk9UIE5VTEwKKTsKCkNSRUFURSBUQUJMRSB0eF9ldmVudHMgKAogICAgaWQgU0VSSUFMIFBSSU1BUlkgS0VZLAogICAga2V5IFZBUkNIQVIgTk9UIE5VTEwsCiAgICB2YWx1ZSBWQVJDSEFSIE5PVCBOVUxMLAogICAgaGVpZ2h0IElOVEVHRVIgTk9UIE5VTEwsCiAgICBoYXNoIFZBUkNIQVIgTk9UIE5VTEwsCiAgICB0eF9yZXN1bHRfaWQgU0VSSUFMLAogICAgY3JlYXRlZF9hdCBUSU1FU1RBTVBUWiBOT1QgTlVMTCwKICAgIGNoYWluX2lkIFZBUkNIQVIgTk9UIE5VTEwsCiAgICBGT1JFSUdOIEtFWSAodHhfcmVzdWx0X2lkKQogICAgICAgIFJFRkVSRU5DRVMgdHhfcmVzdWx0cyhpZCkKICAgICAgICBPTiBERUxFVEUgQ0FTQ0FERQopOwoKLS0gSW5kaWNlcyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgpDUkVBVEUgSU5ERVggaWR4X2Jsb2NrX2V2ZW50c19rZXlfdmFsdWUgT04gYmxvY2tfZXZlbnRzKGtleSwgdmFsdWUpOwpDUkVBVEUgSU5ERVggaWR4X3R4X2V2ZW50c19rZXlfdmFsdWUgT04gdHhfZXZlbnRzKGtleSwgdmFsdWUpOwpDUkVBVEUgSU5ERVggaWR4X3R4X2V2ZW50c19oYXNoIE9OIHR4X2V2ZW50cyhoYXNoKTsK"}}),e._v(" "),n("p",[e._v("The "),n("code",[e._v("PSQLEventSink")]),e._v(" will implement the "),n("code",[e._v("EventSink")]),e._v(" interface as follows\n(some details omitted for brevity):")]),e._v(" "),n("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"ZnVuYyBOZXdQU1FMRXZlbnRTaW5rKGNvbm5TdHIgc3RyaW5nLCBjaGFpbklEIHN0cmluZykgKCpQU1FMRXZlbnRTaW5rLCBlcnJvcikgewogIGRiLCBlcnIgOj0gc3FsLk9wZW4oJnF1b3Q7cG9zdGdyZXMmcXVvdDssIGNvbm5TdHIpCiAgaWYgZXJyICE9IG5pbCB7CiAgICByZXR1cm4gbmlsLCBlcnIKICB9CgogIC8vIC4uLgp9CgpmdW5jIChlcyAqUFNRTEV2ZW50U2luaykgSW5kZXhCbG9ja0V2ZW50cyhoIHR5cGVzLkV2ZW50RGF0YU5ld0Jsb2NrSGVhZGVyKSBlcnJvciB7CiAgc3FsU3RtdCA6PSBzcS5JbnNlcnQoJnF1b3Q7YmxvY2tfZXZlbnRzJnF1b3Q7KS5Db2x1bW5zKCZxdW90O2tleSZxdW90OywgJnF1b3Q7dmFsdWUmcXVvdDssICZxdW90O2hlaWdodCZxdW90OywgJnF1b3Q7dHlwZSZxdW90OywgJnF1b3Q7Y3JlYXRlZF9hdCZxdW90OywgJnF1b3Q7Y2hhaW5faWQmcXVvdDspCgogIC8vIGluZGV4IHRoZSByZXNlcnZlZCBibG9jayBoZWlnaHQgaW5kZXgKICB0cyA6PSB0aW1lLk5vdygpCiAgc3FsU3RtdCA9IHNxbFN0bXQuVmFsdWVzKHR5cGVzLkJsb2NrSGVpZ2h0S2V5LCBoLkhlYWRlci5IZWlnaHQsIGguSGVhZGVyLkhlaWdodCwgJnF1b3Q7JnF1b3Q7LCB0cywgZXMuY2hhaW5JRCkKCiAgZm9yIF8sIGV2ZW50IDo9IHJhbmdlIGguUmVzdWx0QmVnaW5CbG9jay5FdmVudHMgewogICAgLy8gb25seSBpbmRleCBldmVudHMgd2l0aCBhIG5vbi1lbXB0eSB0eXBlCiAgICBpZiBsZW4oZXZlbnQuVHlwZSkgPT0gMCB7CiAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgZm9yIF8sIGF0dHIgOj0gcmFuZ2UgZXZlbnQuQXR0cmlidXRlcyB7CiAgICAgIGlmIGxlbihhdHRyLktleSkgPT0gMCB7CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgLy8gaW5kZXggaWZmIHRoZSBldmVudCBzcGVjaWZpZWQgaW5kZXg6dHJ1ZSBhbmQgaXQncyBub3QgYSByZXNlcnZlZCBldmVudAogICAgICBjb21wb3NpdGVLZXkgOj0gZm10LlNwcmludGYoJnF1b3Q7JXMuJXMmcXVvdDssIGV2ZW50LlR5cGUsIHN0cmluZyhhdHRyLktleSkpCiAgICAgIGlmIGNvbXBvc2l0ZUtleSA9PSB0eXBlcy5CbG9ja0hlaWdodEtleSB7CiAgICAgICAgcmV0dXJuIGZtdC5FcnJvcmYoJnF1b3Q7ZXZlbnQgdHlwZSBhbmQgYXR0cmlidXRlIGtleSBcJnF1b3Q7JXNcJnF1b3Q7IGlzIHJlc2VydmVkOyBwbGVhc2UgdXNlIGEgZGlmZmVyZW50IGtleSZxdW90OywgY29tcG9zaXRlS2V5KQogICAgICB9CgogICAgICBpZiBhdHRyLkdldEluZGV4KCkgewogICAgICAgIHNxbFN0bXQgPSBzcWxTdG10LlZhbHVlcyhjb21wb3NpdGVLZXksIHN0cmluZyhhdHRyLlZhbHVlKSwgaC5IZWFkZXIuSGVpZ2h0LCBCbG9ja0V2ZW50VHlwZUJlZ2luQmxvY2ssIHRzLCBlcy5jaGFpbklEKQogICAgICB9CiAgICB9CiAgfQoKICAvLyBpbmRleCBlbmRfYmxvY2sgZXZlbnRzLi4uCiAgLy8gZXhlY3V0ZSBzcWxTdG10IGRiIHF1ZXJ5Li4uCn0KCmZ1bmMgKGVzICpQU1FMRXZlbnRTaW5rKSBJbmRleFR4RXZlbnRzKHR4ciBbXSphYmNpLlR4UmVzdWx0KSBlcnJvciB7CiAgc3FsU3RtdEV2ZW50cyA6PSBzcS5JbnNlcnQoJnF1b3Q7dHhfZXZlbnRzJnF1b3Q7KS5Db2x1bW5zKCZxdW90O2tleSZxdW90OywgJnF1b3Q7dmFsdWUmcXVvdDssICZxdW90O2hlaWdodCZxdW90OywgJnF1b3Q7aGFzaCZxdW90OywgJnF1b3Q7dHhfcmVzdWx0X2lkJnF1b3Q7LCAmcXVvdDtjcmVhdGVkX2F0JnF1b3Q7LCAmcXVvdDtjaGFpbl9pZCZxdW90OykKICBzcWxTdG10VHhSZXN1bHQgOj0gc3EuSW5zZXJ0KCZxdW90O3R4X3Jlc3VsdHMmcXVvdDspLkNvbHVtbnMoJnF1b3Q7dHhfcmVzdWx0JnF1b3Q7LCAmcXVvdDtjcmVhdGVkX2F0JnF1b3Q7KQoKICB0cyA6PSB0aW1lLk5vdygpCiAgZm9yIF8sIHR4IDo9IHJhbmdlIHR4ciB7CiAgICAvLyBzdG9yZSB0aGUgdHggcmVzdWx0CiAgICB0eEJ6LCBlcnIgOj0gcHJvdG8uTWFyc2hhbCh0eCkKICAgIGlmIGVyciAhPSBuaWwgewogICAgICByZXR1cm4gZXJyCiAgICB9CgogICAgc3FsU3RtdFR4UmVzdWx0ID0gc3FsU3RtdFR4UmVzdWx0LlZhbHVlcyh0eEJ6LCB0cykKCiAgICAvLyBleGVjdXRlIHNxbFN0bXRUeFJlc3VsdCBkYiBxdWVyeS4uLgogICAgdmFyIHR4SUQgdWludDMyCiAgICBlcnIgPSBzcWxTdG10VHhSZXN1bHQuUXVlcnlSb3coKS5TY2FuKCZhbXA7dHhJRCkKCQlpZiBlcnIgIT0gbmlsIHsKCQkJcmV0dXJuIGVycgoJCX0KCiAgICAvLyBpbmRleCB0aGUgcmVzZXJ2ZWQgaGVpZ2h0IGFuZCBoYXNoIGluZGljZXMKICAgIGhhc2ggOj0gdHlwZXMuVHgodHguVHgpLkhhc2goKQogICAgc3FsU3RtdEV2ZW50cyA9IHNxbFN0bXRFdmVudHMuVmFsdWVzKHR5cGVzLlR4SGFzaEtleSwgaGFzaCwgdHguSGVpZ2h0LCBoYXNoLCB0eElELCB0cywgZXMuY2hhaW5JRCkKICAgIHNxbFN0bXRFdmVudHMgPSBzcWxTdG10RXZlbnRzLlZhbHVlcyh0eXBlcy5UeEhlaWdodEtleSwgdHguSGVpZ2h0LCB0eC5IZWlnaHQsIGhhc2gsIHR4SUQsIHRzLCBlcy5jaGFpbklEKQoKICAgIGZvciBfLCBldmVudCA6PSByYW5nZSByZXN1bHQuUmVzdWx0LkV2ZW50cyB7CiAgICAgIC8vIG9ubHkgaW5kZXggZXZlbnRzIHdpdGggYSBub24tZW1wdHkgdHlwZQogICAgICBpZiBsZW4oZXZlbnQuVHlwZSkgPT0gMCB7CiAgICAgICAgY29udGludWUKICAgICAgfQoKICAgICAgZm9yIF8sIGF0dHIgOj0gcmFuZ2UgZXZlbnQuQXR0cmlidXRlcyB7CiAgICAgICAgaWYgbGVuKGF0dHIuS2V5KSA9PSAwIHsKICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgfQoKICAgICAgICAvLyBpbmRleCBpZiBgaW5kZXg6IHRydWVgIGlzIHNldAogICAgICAgIGNvbXBvc2l0ZVRhZyA6PSBmbXQuU3ByaW50ZigmcXVvdDslcy4lcyZxdW90OywgZXZlbnQuVHlwZSwgc3RyaW5nKGF0dHIuS2V5KSkKCQkJCiAgICAgICAgLy8gZW5zdXJlIGV2ZW50IGRvZXMgbm90IGNvbmZsaWN0IHdpdGggYSByZXNlcnZlZCBwcmVmaXgga2V5CiAgICAgICAgaWYgY29tcG9zaXRlVGFnID09IHR5cGVzLlR4SGFzaEtleSB8fCBjb21wb3NpdGVUYWcgPT0gdHlwZXMuVHhIZWlnaHRLZXkgewogICAgICAgICAgcmV0dXJuIGZtdC5FcnJvcmYoJnF1b3Q7ZXZlbnQgdHlwZSBhbmQgYXR0cmlidXRlIGtleSBcJnF1b3Q7JXNcJnF1b3Q7IGlzIHJlc2VydmVkOyBwbGVhc2UgdXNlIGEgZGlmZmVyZW50IGtleSZxdW90OywgY29tcG9zaXRlVGFnKQogICAgICAgIH0KCQkKICAgICAgICBpZiBhdHRyLkdldEluZGV4KCkgewogICAgICAgICAgc3FsU3RtdEV2ZW50cyA9IHNxbFN0bXRFdmVudHMuVmFsdWVzKGNvbXBvc2l0ZUtleSwgc3RyaW5nKGF0dHIuVmFsdWUpLCB0eC5IZWlnaHQsIGhhc2gsIHR4SUQsIHRzLCBlcy5jaGFpbklEKQogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAKICAvLyBleGVjdXRlIHNxbFN0bXRFdmVudHMgZGIgcXVlcnkuLi4KfQoKZnVuYyAoZXMgKlBTUUxFdmVudFNpbmspIFNlYXJjaEJsb2NrRXZlbnRzKGN0eCBjb250ZXh0LkNvbnRleHQsIHEgKnF1ZXJ5LlF1ZXJ5KSAoW11pbnQ2NCwgZXJyb3IpIHsKICByZXR1cm4gbmlsLCBlcnJvcnMuTmV3KCZxdW90O2Jsb2NrIHNlYXJjaCBpcyBub3Qgc3VwcG9ydGVkIHZpYSB0aGUgcG9zdGdyZXMgZXZlbnQgc2luayZxdW90OykKfQoKZnVuYyAoZXMgKlBTUUxFdmVudFNpbmspIFNlYXJjaFR4RXZlbnRzKGN0eCBjb250ZXh0LkNvbnRleHQsIHEgKnF1ZXJ5LlF1ZXJ5KSAoW10qYWJjaS5UeFJlc3VsdCwgZXJyb3IpIHsKICByZXR1cm4gbmlsLCBlcnJvcnMuTmV3KCZxdW90O3R4IHNlYXJjaCBpcyBub3Qgc3VwcG9ydGVkIHZpYSB0aGUgcG9zdGdyZXMgZXZlbnQgc2luayZxdW90OykKfQoKZnVuYyAoZXMgKlBTUUxFdmVudFNpbmspIEdldFR4QnlIYXNoKGhhc2ggW11ieXRlKSAoKmFiY2kuVHhSZXN1bHQsIGVycm9yKSB7CglyZXR1cm4gbmlsLCBlcnJvcnMuTmV3KCZxdW90O2dldFR4QnlIYXNoIGlzIG5vdCBzdXBwb3J0ZWQgdmlhIHRoZSBwb3N0Z3JlcyBldmVudCBzaW5rJnF1b3Q7KQp9CgpmdW5jIChlcyAqUFNRTEV2ZW50U2luaykgSGFzQmxvY2soaCBpbnQ2NCkgKGJvb2wsIGVycm9yKSB7CglyZXR1cm4gZmFsc2UsIGVycm9ycy5OZXcoJnF1b3Q7aGFzQmxvY2sgaXMgbm90IHN1cHBvcnRlZCB2aWEgdGhlIHBvc3RncmVzIGV2ZW50IHNpbmsmcXVvdDspCn0K"}}),e._v(" "),n("h3",{attrs:{id:"configuration"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[e._v("#")]),e._v(" Configuration")]),e._v(" "),n("p",[e._v("The current "),n("code",[e._v("tx_index.indexer")]),e._v(" configuration would be changed to accept a list\nof supported "),n("code",[e._v("EventSink")]),e._v(" types instead of a single value.")]),e._v(" "),n("p",[e._v("Example:")]),e._v(" "),n("tm-code-block",{staticClass:"codeblock",attrs:{language:"toml",base64:"W3R4X2luZGV4XQoKaW5kZXhlciA9IFsKICAmcXVvdDtrdiZxdW90OywKICAmcXVvdDtwc3FsJnF1b3Q7Cl0K"}}),e._v(" "),n("p",[e._v("If the "),n("code",[e._v("indexer")]),e._v(" list contains the "),n("code",[e._v("null")]),e._v(" indexer, then no indexers will be used\nregardless of what other values may exist.")]),e._v(" "),n("p",[e._v("Additional configuration parameters might be required depending on what event\nsinks are supplied to "),n("code",[e._v("tx_index.indexer")]),e._v(". The "),n("code",[e._v("psql")]),e._v(" will require an additional\nconnection configuration.")]),e._v(" "),n("tm-code-block",{staticClass:"codeblock",attrs:{language:"toml",base64:"W3R4X2luZGV4XQoKaW5kZXhlciA9IFsKICAmcXVvdDtrdiZxdW90OywKICAmcXVvdDtwc3FsJnF1b3Q7Cl0KCnBxc3FsX2Nvbm4gPSAmcXVvdDtwb3N0Z3Jlc3FsOi8vJmx0O3VzZXImZ3Q7OiZsdDtwYXNzd29yZCZndDtAJmx0O2hvc3QmZ3Q7OiZsdDtwb3J0Jmd0Oy8mbHQ7ZGImZ3Q7PyZsdDtvcHRzJmd0OyZxdW90Owo="}}),e._v(" "),n("p",[e._v("Any invalid or misconfigured "),n("code",[e._v("tx_index")]),e._v(" configuration should yield an error as\nearly as possible.")]),e._v(" "),n("h2",{attrs:{id:"future-improvements"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#future-improvements"}},[e._v("#")]),e._v(" Future Improvements")]),e._v(" "),n("p",[e._v('Although not technically required to maintain feature parity with the current\nexisting Tendermint indexer, it would be beneficial for operators to have a method\nof performing a "re-index". Specifically, Tendermint operators could invoke an\nRPC method that allows the Tendermint node to perform a re-indexing of all block\nand transaction events between two given heights, H'),n("sub",[e._v("1")]),e._v(" and H"),n("sub",[e._v("2")]),e._v(",\nso long as the block store contains the blocks and transaction results for all\nthe heights specified in a given range.")]),e._v(" "),n("h2",{attrs:{id:"consequences"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#consequences"}},[e._v("#")]),e._v(" Consequences")]),e._v(" "),n("h3",{attrs:{id:"positive"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#positive"}},[e._v("#")]),e._v(" Positive")]),e._v(" "),n("ul",[n("li",[e._v("A more robust and flexible indexing and query engine for indexing and search\nblock and transaction events.")]),e._v(" "),n("li",[e._v("The ability to not have to support a custom indexing and query engine beyond\nthe legacy "),n("code",[e._v("kv")]),e._v(" type.")]),e._v(" "),n("li",[e._v("The ability to offload/proxy indexing and querying to the underling sink.")]),e._v(" "),n("li",[e._v('Scalability and reliability that essentially comes "for free" from the underlying\nsink, if it supports it.')])]),e._v(" "),n("h3",{attrs:{id:"negative"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#negative"}},[e._v("#")]),e._v(" Negative")]),e._v(" "),n("ul",[n("li",[e._v("The need to support multiple and potentially a growing set of custom "),n("code",[e._v("EventSink")]),e._v("\ntypes.")])]),e._v(" "),n("h3",{attrs:{id:"neutral"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#neutral"}},[e._v("#")]),e._v(" Neutral")]),e._v(" "),n("h2",{attrs:{id:"references"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[e._v("#")]),e._v(" References")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/cosmos/cosmos-sdk/blob/master/docs/architecture/adr-038-state-listening.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cosmos SDK ADR-038"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://www.postgresql.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("PostgreSQL"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://www.sqlite.org/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("SQLite"),n("OutboundLink")],1)])])],1)}),[],!1,null,null,null);t.default=i.exports}}]);